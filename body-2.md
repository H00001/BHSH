# 第4章 系统软件设计

在微机测控系统中，软件与硬件同样重要。硬件是系统的躯体，软件则是灵魂，当系统的硬件电路设计好之后，系统的主要功能还是要靠软件来实现，而且软件的设计在很大程度上决定了测控系统的性能。为了满足系统的要求，编制软件时一般要符合以下基本要求：  

1. 易理解性、易维护性。通常是指软件系统容易阅读和理解，容易发现和纠正错误，容易修改和补充。由于生产过程自动化程度的不断提高，测控系统的结构日趋复杂，设计人员很难在短时间内就对整个系统理解无误，软件的设计与调试不可能一次完成，有些问题是在运行中逐步暴露出来，这就要求编制的软件容易理解和修改。在软件的设计方法中，结构化设计是最好的一种设计方法，这种设计方法是由整体到局部，然后再由局部到细节，先考虑整个系统所要实现的功能，确定整体目标，然后把这个目标分成一个个的任务。任务中可以分成若干个子任务，送样逐层细分，逐个实现。本仪表就是采用这种模块化的设计方法。这样不但使得设计目标明确、思路清晰，而且在检错、调试时也很方便。当出现问题时，可以根据问题的种类和现象来判断是哪一部分出的问题，很容易找出故障所在和故障原因。同时，采用模块化程序结构设计方案，对于系统功能的扩充和修改也提供了很大的方便。
2. 实时性是电子测量系统的普遍要求，即要求系统及时响应外部事件的发生，并及时给出处理结果。近年来，由于硬件的集成度与运算速度的提高，配合相应的软件，实时性比较容易满足设计要求；
3. 准确性对整个系统具有重要意义，尤其是测量系统，系统要进行一定量的运算，算法的正确性和准确性对结果有着直接的影响，因此在算法的选择、计算的精度等方面都要符合设计的要求；
4. 可靠性是系统软件最重要的指标之一，作为能够稳定运行的系统，抗干扰技术的应用是必不可少的，最起码的要求是在软件受到干扰出现异常时，系统还能恢复正常工作。结合上述编制系统软件的基本要求，首先讨论软件的设计思想。

在微机测控系统中，软件的重要性与硬件设置同样重要。硬件是躯体，软件是灵魂，当系统的硬件电路确定之后，系统的主要功能还要靠软件来实现。如果说硬件决定了产品的造价，那么在硬件搭配合理的前提下软件在很大程度上就决定了产品的性能。

## 4.1 软件设计思想

为了满足系统的要求，编制软件时必须符合以下基本要求: 

易理解性、易维护性。通常是指软件系统容易阅读和理解，容易发现和纠正错误，容易修改和补充。由于生产过程自动化程度的不断提高，测控系统的结构日趋复杂，设计人员很难在短时间内就对整个系统理解无误，软件的设计与调试不可能。

一次完成，有些问题是在运行中逐步暴露出来，这就要求编制的软件容易理解和修改。在软件的设计方法中，结构化设计是最好的一种设计方法，这种设计方法是由整体到局部，然后再由局部到细节，先考虑整个系统所要实现的功能，确定整体目标，然后把这个目标分成一个个的任务。任务中可以分成若干个子任务，送样逐层细分，逐个实现。本仪表就是采用这种模块化的设计方法。这样不但使得设计目标明确、思路清晰，而且在检错、调试时也很方便。当出现问题时，可以根据问题的种类和现象来判断是哪一部分出的问题，很容易找出故障所在和故障原因。同时，采用模块化程序结构设计方案，对于系统功能的扩充和修改也提供了很大的方便。

实时性。实时性是本系统的基本要求。即要求系统及时响应外部事件的发生，并及时给出处理结果。近年来，由于硬件的集成度与速度的提高，配合相应的软件，实时性容易满足要求，特别是对于汇编语言编制的软件。  

1. 可测试性。系统软件的可测试性具有两方面的含义:其一是指比较容易地制定出测试准则，并根据这些准则对软件进行测定；其二是软件设计完成后，首先在模拟环境下运行，经过静态分析和动态仿真运行，证明准确无误后才可投入实际运行。  
2. 准确性。准确性对整个系统具有重要意义。系统要进行大量运算，算法的正确性和准确性问题对控制结果有直接影响，因此在算法选择、位数选择方面要适合要求。
3. 可靠性。可靠性是系统软件最重要的指标之一，它要求两方面的意义:第一是运行参数环境发生变化时，软件都能可靠运行并给出正确结果，也就是要求软件具有自适应性:第二是在环境恶劣干扰严重情况下，软件必须保证也能可靠运行，这对整个系统尤为重要。



## 4.2 软件组成

由于整个系统软件相对比较庞大，为了便于编写、调试、修改和增删，系统软件的编制采用了模块化的设计。即整个控制软件由许多独立的小模块组成，它们之间通过软件接口连接，遵循模块内部数据关系紧凑，模块之间数据关系松散的原则，按功能形成模块化结构。

系统的软件主要由主程序模块、数据采集模块、数据处理模块、控制算法模块等组成。主模块的功能是为其余几个模块构建整体框架及初始化工作；数据采集模块的作用是将A／D转换的数字量采集并储存到存储器中；数据处理模块是将采集到的数据进行一系列的处理，其中最重要的是数字滤波程序：控制算法模块完成控制系统的PID运算并且输出控制量。

下面就介绍本系统几个主要的程序模块。

## 4.3 程序结构分析

**主程序调用了4个子程序，分别是温度传感器读取程序，数码管显示程序、键盘扫描及按键处理程序、温度信号处理程序。**

* 键盘扫描电路及按键处理程序：实现键盘的输入按键的识别及进入相应的程序。
* 温度信号处理程序：对温度芯片送过来的数据进行处理，进行判断和显示。
* 数码管显示程序：向数码的显示送数，控制系统的显示部分。




## 4.4 数据处理模块

数据处理模块负责处理A／D转换后的数字量。其中最重要的环节是数字滤波，所以这里主要讨论系统采用的数字滤波程序。

###  4.4.1 数字滤波

模拟信号都必须经过A／D转换后才能为单片机接受，如果模拟信号受到扰动影响，将使A／D转换结果偏离真实值。因此仅仅对模拟量采样一次，我们是无法确定该结果是否可信的，必须经过多次采样，得到一个A／D转换的数据序列，通过某种处理后，才能得到一个可信度较高的结果。这种从数据序列中提取逼近真值数据的软件算法，通常称为数字滤波算法。

数字滤波克服了模拟滤波器的不足，它与模拟滤波器相比具有以下几个方面的优点:  

1. 由于数字滤波是用程序实现的，因而不需要增加硬件设备，而且可以多个输入通道共用一个滤波程序
2. 由于数字滤波不需要硬件设备，因而可靠性高、稳定性好，各回路之间不存在阻抗匹配等问题
3. 数字滤波可以对频率很低(如O．01HZ)的信号实现滤波，克服了模拟滤波器的缺陷，而且通过改

变数字滤波程序，可以实现不同的滤波方法或改变滤波参数，这比改变模拟滤波器的硬件要更灵活方便。

常用的数字滤波方法有程序判断滤波法、中值滤波法、算术平均滤波法、一阶滞后滤波法、去极值平均滤波法等等，下面简要介绍这几种数字滤波方法。

1. 程序判断滤波法首先要从经验出发，定出一个目标参数最大可能的变化范围。每次采样后都和上次的有效采样值进行比较，如果变化幅度不超过经验值，本次采样有效，否则，本次采样值应视为干扰而放弃，以上次采样值为准。该算法适用于变化缓慢的物理参数的采样过程，如湿度、液位等。
2. 中值滤波法对目标参数连续进行若干次采样，然后将这些采样进行排序，选取中间位置的采样值为有效值。对于变化较为剧烈的参数，此滤波方法不宜采用。
3. 算术平均滤波法是对目标参数进行连续采样，然后求其算术平均值作为有效采样值。该算法适用于抑制随机干扰。采样次数越大，平滑效果越好，但系统的灵敏度要下降。算术平均滤波不能将明显的脉冲干扰消除，只是将其影响削弱。

## 4.5 子程序设计

设计总体程序框图如下，总体程序由主程序，按键子程序，温度获取子程序三部分组成。  
读出温度子程序的主要功能包括初始化,判断DS18B20是否存在,若存在则进行一系列的读操,作若不存在则返回。

### 4.5.1 读出温度子程序

![图4-6 程序结构图](http://my.gunplan.top/static/4.2.1.PNG)

### 4.5.2 LED数码显示管程序

![图4-6 发光二级 数码显示管程序](http://my.gunplan.top/static/4.2.2.PNG)

### 4.5.3 键盘扫描及按键处理子程序

![图4-7  键盘扫描及按键处理子程序](http://my.gunplan.top/static/4.2.3.PNG)


## 4.6 显示处理

显示处理模块主要完成人机交互作用，具体实现将采样温度值、设定温度值以字符的形式通过液晶显示出来。本系统使用HTl621作为显示驱动器。HTl621是128点内存映象和多功能驱动器。附录中给出了显示处理模块的源程序。

