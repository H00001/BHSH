# 系统软件设计

任何形式的微机都离不开软件。软件设计是设计硬件的重要部分，通过软件才能让单片机实现他的功能，其实再从设计方案开始时就应该考虑到软件设计，因为软件程序的大小，决定这硬件CPU的内存选择，这就要涉及到单片机的选型了，这样可方便软件和硬件之间的相互协调工作，并且想好之后的软件设计和调试工具。当硬件做好之后软件设计就可开展开来，软件是可以单独编写然后进行调试的，当再测试工具上么有问题时，就可将软件下载单片机中来，测试硬件的功能。
对于程序设计应该满足以下要求：
1. 可靠性，对于任何硬件来言，其驱动程序都应该要求工作可靠，如果程序本身就不可靠的话，那么不管他设计的有多么巧妙，功能多齐全，结构都复杂这都是毫无用处的。它与硬件的设计不同，硬件的使用可能会受到外部因素的影响，但对于软件来他的可靠性主要在于程序是否正确。
2. 精度，程序中可能包含着大量计算，可能有大量的函数使用和复杂的数据处理，就拿本设计而言，在温度采集中采用串联分压方式最终传感器采集的是电信号，并不能被单片机直接接收，所以还要加数模转换，单片机内部的10位AD转换在计算温度是采用应该是插值的方法，这就需要大量的计算。而且在数码管上显示的时候还需设定显示的精度。
3. 速度，对于硬件来讲，他是有工作周期的，要按照时间节拍执行一步步指令，如果程序执行速度很慢的话，在工作周期内不能够完成相应的操作，就可能会造成丢失或者某些重要操作的延误。
4. 易理解性、易维护性。通常是指软件系统容易阅读和理解，容易发现和纠正错误，容易修改和补充。由于生产过程自动化程度的不断提高，测控系统的结构日趋复杂，设计人员很难在短时间内就对整个系统理解无误，软件的设计与调试不可能一次完成，有些问题是在运行中逐步暴露出来，这就要求编制的软件容易理解和修改。在软件的设计方法中，结构化设计是最好的一种设计方法，这种设计方法是由整体到局部，然后再由局部到细节，先考虑整个系统所要实现的功能，确定整体目标，然后把这个目标分成一个个的任务。任务中可以分成若干个子任务，送样逐层细分，逐个实现。本仪表就是采用这种模块化的设计方法。这样不但使得设计目标明确、思路清晰，而且在检错、调试时也很方便。当出现问题时，可以根据问题的种类和现象来判断是哪一部分出的问题，很容易找出故障所在和故障原因。同时，采用模块化程序结构设计方案，对于系统功能的扩充和修改也提供了很大的方便。
5. 实时性是电子测量系统的普遍要求，即要求系统及时响应外部事件的发生，并及时给出处理结果。近年来，由于硬件的集成度与运算速度的提高，配合相应的软件，实时性比较容易满足设计要求；
6. 准确性对整个系统具有重要意义，尤其是测量系统，系统要进行一定量的运算，算法的正确性和准确性对结果有着直接的影响，因此在算法的选择、计算的精度等方面都要符合设计的要求；
7. 可靠性是系统软件最重要的指标之一，作为能够稳定运行的系统，抗干扰技术的应用是必不可少的，最起码的要求是在软件受到干扰出现异常时，系统还能恢复正常工作。结合上述编制系统软件的基本要求，首先讨论软件的设计思想。

软件设计的基本方法是结构化程序设计基本步骤为：
1. 从上到下分层设计，把整个软件任务划分若干大的任务，每个大任务再分若干个小任务，这样一层层的分下去，直到这个小任务可以用编程语言实现为止，一般是先从主程序来设计，其他子程序，分程序，先用一些模块来代替，当系统一级程序编好之后，再将这些模块一次扩展为模块，，从而完成整个程序的设计。
2. 模块化编程，分层设计没有解决怎么产生每一层次的程序模块，模块化编程可以对同一部分内容的任意改动并且不行其他程序的设计，要不然就不能够将这些组成同一模块，按照这样思路模块内的程序更利于独立运行、修改和调试，方便实现一些有独特功能的子程序设计。
3. 结构化编程，采用模块化的结构程序更利于进一步细分，优于任何单一入口和出口的程序呢都是有以下三种基本结构组成：顺序结构、条件结构、循环结构。这三种结构在编程语言中都有对应的语句或者指令，而且他们都是单一出口和入口，这样查找问题是很方便。
现在单片机主要的开发语言是C语言，C语言相对比汇编来讲有更好的可靠性并且他可反复擦写。而且在设计完成相同功能的程序时，C语言的效率要比汇编的效率高出很多。并且更加方便调试和更改。其编程语言相能够更好兼容其他高级语言和和汇编词汇，同时也能够象汇编那样根据硬件的内部特性来设计程序驱动单片机的内部寄存器和外部接口。C语言是一种能快速上手而且易懂的结构化编程语言。每一程序都可以由一个或者多个相互独立的程序组成，可以互相调用。其语言模块还能够与汇编相互组合成为一个完整的程序。在目前的单片机编程序言中，C语言越来越受到人们的欢迎。


## 软件设计思想

为了满足系统的要求，编制软件时必须符合以下基本要求: 

易理解性、易维护性。通常是指软件系统容易阅读和理解，容易发现和纠正错误，容易修改和补充。由于生产过程自动化程度的不断提高，测控系统的结构日趋复杂，设计人员很难在短时间内就对整个系统理解无误，软件的设计与调试不可能。

一次完成，有些问题是在运行中逐步暴露出来，这就要求编制的软件容易理解和修改。在软件的设计方法中，结构化设计是最好的一种设计方法，这种设计方法是由整体到局部，然后再由局部到细节，先考虑整个系统所要实现的功能，确定整体目标，然后把这个目标分成一个个的任务。任务中可以分成若干个子任务，送样逐层细分，逐个实现。本仪表就是采用这种模块化的设计方法。这样不但使得设计目标明确、思路清晰，而且在检错、调试时也很方便。当出现问题时，可以根据问题的种类和现象来判断是哪一部分出的问题，很容易找出故障所在和故障原因。同时，采用模块化程序结构设计方案，对于系统功能的扩充和修改也提供了很大的方便。

实时性。实时性是本系统的基本要求。即要求系统及时响应外部事件的发生，并及时给出处理结果。近年来，由于硬件的集成度与速度的提高，配合相应的软件，实时性容易满足要求，特别是对于汇编语言编制的软件。  

1. 可测试性。系统软件的可测试性具有两方面的含义:其一是指比较容易地制定出测试准则，并根据这些准则对软件进行测定；其二是软件设计完成后，首先在模拟环境下运行，经过静态分析和动态仿真运行，证明准确无误后才可投入实际运行。  
2. 准确性。准确性对整个系统具有重要意义。系统要进行大量运算，算法的正确性和准确性问题对控制结果有直接影响，因此在算法选择、位数选择方面要适合要求。
3. 可靠性。可靠性是系统软件最重要的指标之一，它要求两方面的意义:第一是运行参数环境发生变化时，软件都能可靠运行并给出正确结果，也就是要求软件具有自适应性:第二是在环境恶劣干扰严重情况下，软件必须保证也能可靠运行，这对整个系统尤为重要。



## 软件组成

由于整个系统软件相对比较庞大，为了便于编写、调试、修改和增删，系统软件的编制采用了模块化的设计。即整个控制软件由许多独立的小模块组成，它们之间通过软件接口连接，遵循模块内部数据关系紧凑，模块之间数据关系松散的原则，按功能形成模块化结构。

系统的软件主要由主程序模块、数据采集模块、数据处理模块、控制算法模块等组成。主模块的功能是为其余几个模块构建整体框架及初始化工作；数据采集模块的作用是将A／D转换的数字量采集并储存到存储器中；数据处理模块是将采集到的数据进行一系列的处理，其中最重要的是数字滤波程序：控制算法模块完成控制系统的PID运算并且输出控制量。

下面就介绍本系统几个主要的程序模块。

## 程序结构分析

**主程序调用了4个子程序，分别是温度传感器读取程序，数码管显示程序、键盘扫描及按键处理程序、温度信号处理程序。**

* 键盘扫描电路及按键处理程序：实现键盘的输入按键的识别及进入相应的程序。
* 温度信号处理程序：对温度芯片送过来的数据进行处理，进行判断和显示。
* 数码管显示程序：向数码的显示送数，控制系统的显示部分。




## 数据处理模块

数据处理模块负责处理A／D转换后的数字量。其中最重要的环节是数字滤波，所以这里主要讨论系统采用的数字滤波程序。

### 数字滤波

模拟信号都必须经过A／D转换后才能为单片机接受，如果模拟信号受到扰动影响，将使A／D转换结果偏离真实值。因此仅仅对模拟量采样一次，我们是无法确定该结果是否可信的，必须经过多次采样，得到一个A／D转换的数据序列，通过某种处理后，才能得到一个可信度较高的结果。这种从数据序列中提取逼近真值数据的软件算法，通常称为数字滤波算法。

数字滤波克服了模拟滤波器的不足，它与模拟滤波器相比具有以下几个方面的优点:  

1. 由于数字滤波是用程序实现的，因而不需要增加硬件设备，而且可以多个输入通道共用一个滤波程序
2. 由于数字滤波不需要硬件设备，因而可靠性高、稳定性好，各回路之间不存在阻抗匹配等问题
3. 数字滤波可以对频率很低(如O．01HZ)的信号实现滤波，克服了模拟滤波器的缺陷，而且通过改

变数字滤波程序，可以实现不同的滤波方法或改变滤波参数，这比改变模拟滤波器的硬件要更灵活方便。

常用的数字滤波方法有程序判断滤波法、中值滤波法、算术平均滤波法、一阶滞后滤波法、去极值平均滤波法等等，下面简要介绍这几种数字滤波方法。

1. 程序判断滤波法首先要从经验出发，定出一个目标参数最大可能的变化范围。每次采样后都和上次的有效采样值进行比较，如果变化幅度不超过经验值，本次采样有效，否则，本次采样值应视为干扰而放弃，以上次采样值为准。该算法适用于变化缓慢的物理参数的采样过程，如湿度、液位等。
2. 中值滤波法对目标参数连续进行若干次采样，然后将这些采样进行排序，选取中间位置的采样值为有效值。对于变化较为剧烈的参数，此滤波方法不宜采用。
3. 算术平均滤波法是对目标参数进行连续采样，然后求其算术平均值作为有效采样值。该算法适用于抑制随机干扰。采样次数越大，平滑效果越好，但系统的灵敏度要下降。算术平均滤波不能将明显的脉冲干扰消除，只是将其影响削弱。

## 子程序设计

设计总体程序框图如下，总体程序由主程序，按键子程序，温度获取子程序三部分组成。  
读出温度子程序的主要功能包括初始化,判断DS18B20是否存在,若存在则进行一系列的读操,作若不存在则返回。

### 读出温度子程序

![图4-6 程序结构图](http://my.gunplan.top/static/4.2.1.PNG)

### LED数码显示管程序

![图4-6 发光二级 数码显示管程序](http://my.gunplan.top/static/4.2.2.PNG)

### 键盘扫描及按键处理子程序

![图4-7  键盘扫描及按键处理子程序](http://my.gunplan.top/static/4.2.3.PNG)


## 显示处理

显示处理模块主要完成人机交互作用，具体实现将采样温度值、设定温度值以字符的形式通过液晶显示出来。本系统使用HTl621作为显示驱动器。HTl621是128点内存映象和多功能驱动器。附录中给出了显示处理模块的源程序。

