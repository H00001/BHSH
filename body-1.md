# 第3章 系统硬件电路设计

## 3.1 AT89C51单片机简介

AT89C51是一种带4K字节闪烁可编程可擦除只读存储器（FPE只读存储器—Flash Prog随机存取存储器mable and Erasable Read Only Memory）的低电压，高性能CMOS8位微处理器，俗称单片机。该器件采用ATMEL高密度非易失存储器制造技术制造，与工业标准的MCS-51指令集和输出管脚相兼容。由于将多功能8位中央处理单元和闪烁存储器组合在单个芯片中，ATMEL的AT89C51是一种高效微控制器，为很多嵌入式控制系统提供了一种灵活性高且价廉的方案。

![3-8 硬件电路图](http://my.gunplan.top/static/03.jpg)

此方案以AT89C51为核心，通过DS18B20检测房间温度，将信号传输至单片机，用四位发光二极管数码管显示温度，同时通过将检测的温度与标准设定温度的偏差来控制电阻丝通断时间的长短，从而达到恒温控制的目的。

## 3.2 传感器接口电路设计

### 3.2.1 温度数据采集电路

DS18B20是美国DALLAS半导体公司生产的可组网数字式温度传感器，与其它温度传感器相比，DS18B20具有以下特性：独特的单线接口方式，DS18B20在与微处理器连接时仅需要一条口线即可实现微处理器与DS18B20的双向通讯。

DS18B20支持多点组网功能，多个DS18B20可以并联在唯一的三线上，实现组网多点测温。DS18B20在使用中不需要任何外围元件，全部传感器元件及转换电路集成在形如一只三极管的集成电路内。温度范围－55℃～＋125℃，固有测温分辨率±0.5℃；测量结果直接输出数字温度信号，以“一线总线”串行传送给中央处理单元，同时可传送CRC效验码，具有极强的抗干扰纠错能力；测量结果以9位数字量方式串行传送。

DS18B20虽然具有测温系统简单、测温精度高、连接方便、占用口线少等优点，但在实际应用中也应注意以下几方面的问题：

1. 系统的硬件虽然简单但需要相对复杂的软件进行补偿，由于DS18B20与微处理器间采用串行数据传送，因此，在对DS18B20进行读写编程时，必须严格的保证读写时序，否则将无法读取测温结果。
2. 在DS18B20的有关资料中均未提及单总线上所挂DS18B20数量问题，容易使人误认为可以挂任意多个DS18B20，在实际应用中并非如此。当单总线上所挂DS18B20超过8个时，就需要解决微处理器的总线驱动问题，这一点在进行多点测温系统设计时要加以注意。
3. 连接DS18B20的总线电缆有长度限制。由于信号电缆本身存在电阻，距离过长时将导致信号衰减。试验中，当采用普通信号电缆传输长度超过50m时，读取的测温数据将发生错误。当将总线电缆改为双绞线带屏蔽电缆时，正常通讯距离可达150m。
   DS18B20有PR-35和SOIC两种封装形式，管脚排列如表3.1所示。本系统选用PR-35封装形式。DS18B20返回温度值虽然只有9位，如图3.1.2所示。

|  管脚   | 管脚定义 |     说明      |
| :-----: | :------: | :-----------: |
| 8脚SOIC |          |   3脚PR-35    |
|    2    |    1     |     GND地     |
|    1    |    2     | I/O数据输入端 |
|    8    |    3     |    VCC电源    |
|    3    | 4 5 6 7  |    NC空脚     |

表3-1 DS18B20管脚排列

图3.1.2 DS18B20温度值表示方法
D9为符号位，0表示正，1表示负，高字节的其他位（D10～D15）是以符号位的扩展位表示的；D0～D8为数据位，以二进制补码表示。温度是以1/2℃LSB形式表示的。表3.2为数值和温度的关系。

| 温度 |    数据（二进制)    | 数据（十六进制） |
| :--: | :-----------------: | :--------------: |
| +125 | 0000 0000 1111 1010 |      00FAH       |
| +25  | 0000 0000 0011 0010 |      0032H       |
| +0.5 | 0000 0000 0000 0001 |      0001H       |
|  0   | 0000 0000 0000 0000 |      0000H       |
| +0.5 | 1111 1111 1111 1111 |      FFFFH       |
| -25  | 1111 1111 1100 1110 |      FFCEH       |
| -55  | 1111 1111 1001 0010 |       FF92       |

表3.2 DS18B20数值和温度的关系
因房间环境温度不能出现负温情况，因此本系统不考虑负温情况，这样，在硬件选取上可以考虑选用商业级器件，不必要选用工业级器件，可以大幅度降低成本。因此单片机读取温度信息后，只需将低字节（D0～D8）送入上位机和控制电路即可。

### 3.2.2 发光二极管显示接口电设计

本系统选用的是四位数码管动态实时显示房间温度，显示精度0.10C。具体电路图如图3.2：
![3-2 硬件电路图](http://my.gunplan.top/static/003.jpg)

#### AT89C51单片机

单片机选用ATMEL公司的可在线编程的AT89C51，用于温度采集及数据通讯。AT89C51 是一个低功耗，高性能CMOS 8位单片机，片内含8k Bytes ISP(In-system prog随机存取存储器mable)的可反复擦写1000次的Flash只读程序存储器，器件采用ATMEL公司的高密度、非易失性存储技术制造，兼容标准MCS-53指令系统及80C51引脚结构，芯片内集成了通用8位中央处理器和ISP Flash存储单元，功能强大的微型计算机的AT89C51可为许多嵌入式控制应用系统提供高性价比的解决方案。AT89C51具有如下特点：40个引脚，4k Bytes Flash片内程序存储器，128 bytes的随机存取数据存储器（随机存取存储器），32个外部双向输入/输出（I/O）口，5个中断优先级2层中断嵌套中断，2个16位可编程定时计数器,2个全双工串行通信口，看门狗（WDT）电路，片内时钟振荡器。

AT89C51有3个并行I/O端口，P0:P0.0～P0.7、P1.0～P1.7、P2.0～P2.7。P0端口在没有片内存储器时，可以作为普通I/O口使用，外接存储器时作为地址线/数据线使用。P1端口可以作为普通I/O口使用，同时P1.0、P1.1、P1.5～P1.7还具备特殊功能，如表3.4所示。P2端口在没有片外存储器时，可以作为普通I/O口使用，外接存储器时作为高8位地址使用。

| 引脚 |         特殊功能          |
| :--: | :-----------------------: |
| P1.0 |        T2: 定时器         |
| P1.1 |       T2EX: 定时器        |
| P1.5 | MOSI: 用于在线编程（ISP） |
| P1.6 | MOSI: 用于在线编程（ISP） |
| P1.7 | SCK: 用于在线编程（ISP）  |

表3.4 AT89C51 P1端口的特殊功能

| 引脚 |          特殊功能           |
| :--: | :-------------------------: |
| P3.0 |      RXD (串行口输入)       |
| P3.1 |      TXD (串行口输入)       |
| P3.2 |    INT0 (外部中断输入0)     |
| P3.3 |    INT1 (外部中断输入1)     |
| P3.4 |    T0（定时器0外部输入）    |
| P3.5 |    T1（定时器1外部输入）    |
| P3.6 | WR （外部数据存储器写控制） |
| P3.7 | RD （外部数据存储器读控制） |

表3.5  AT89C51 P3端口的特殊功能

单片机在本房间温度监控系统中主要用于通讯及温度采集。P3.0接DS18B20。P0口用于温度显示接口的设计。单片机与控制电路共用一个外部时钟，采用片内存储器，设有上电复位功能。单片机最小系统如图3.2.1：
![图 3.2.1 单片机最小系统](http://my.gunplan.top/static/003.jpg)



### 3.2.2 发光二极管数码管

发光二极管显示器即为发光二极管显示器，具有显示醒目、成本低、配置灵活、接口方便等特点，单片机应用系统中常用它来显示系统的工作状态和采集的信息输入数值等。

发光二极管显示器按其发光管排布结构的不同，可分为发光二极管数码管显示其和发光二极管点阵显示器。发光二极管数码管主要用来显示数字及少数字母和符号，发光二极管点阵显示器可显示数字、字母、汉子和图形等。发光二极管点阵显示器虽然显示灵活，但其占用的单片机系统软件、硬件资源远大于发光二极管数码管。因此除专门应用大屏幕发光二极管点阵显示或有特殊显示要求场合外，几乎所有单片机应用系统都采用发光二极管数码管显示。本系统选用的是发光二极管数码管显示器。

数码管显示器有两种工作方式，即静态显示方式和动态显示方式。静态显方式程序非常简单，占用中央处理单元时间资源很少，只是在显示字符改变时调用一下显示程序。但硬件电路繁多，每个数码管需要一个8位I/O口、一个8位驱动、8个限流电阻。一般用于数码管位数较少的场合。发光二极管静态显示由于使用的元器件较少，在数码管显示器较多的场合，电路显得烦琐，为了简化线路，减低成本，本系统选用的是动态扫描显示方式。

动态扫描显示方式的工作原理是：逐个地循环点亮各位显示器，也就是说在任意时刻只有1位显示器在显示。为了使人看到所有显示器都在显示，就得加快循环点亮各位显示器的速度（提高扫描频率），利用人眼的视觉残留效应，给人感觉到与全部显示器持续点亮的效果一样。动态扫描显示电路如图3.2.2：

![图3.2.2动态扫描图](http://my.gunplan.top/static/003.jpg)

## 3.3 温度控制电路的设计

通过调节脉冲宽度来控制双向可控硅的通断。当脉冲宽度变宽（占空比增大）时，双向可控硅的导通时间延长，电阻丝加热时间延长从而使温度升高。反之脉冲宽度变窄（占空比减小）时，双向可控硅的导通时间缩短，电阻丝的加热时间缩短使得温度降低。

以此方法来控制温度的恒定不变。

##  3.3 脉宽调制

###  3.3.1 脉宽调制的介绍

PWM就是脉冲宽度调制的英文缩写，方波高电平时间跟周期的比例叫占空比，例如1秒高电平1秒低电平的PWM波占空比是50% 脉宽调制PWM是开关型稳压电源中的术语。这是按稳压的控制方式分类的，除了PWM型，还有PFM型和PWM、PFM混合型。脉宽宽度调制式（PWM）开关型稳压电路是在控制电路输出频率不变的情况下，通过电压反馈调整其占空比，从而达到稳定输出电压的目的。

脉宽调制(PWM)是利用微处理器的数字输出来对模拟电路进行控制的一种非常有效的技术，广泛应用在从测量、通信到功率控制与变换的许多领域中。  

### 3.3.2 基本原理

随着电子技术的发展，出现了多种PWM技术，其中包括：相电压控制PWM、脉宽PWM法、随机PWM、SPWM法、线电压控制PWM等，而在镍氢电池智能充电器中采用的脉宽PWM法，它是把每一脉冲宽度均相等的脉冲列作为PWM波形，通过改变脉冲列的周期可以调频，改变脉冲的宽度或占空比可以调压，采用适当控制方法即可使电压与频率协调变化。可以通过调整PWM的周期、PWM的占空比而达到控制充电电流的目的。 

模拟信号的值可以连续变化，其时间和幅度的分辨率都没有限制。9V电池就是一种模拟器件，因为它的输出电压并不精确地等于9V，而是随时间发生变化，并可取任何实数值。与此类似，从电池吸收的电流也不限定在一组可能的取值范围之内。模拟信号与数字信号的区别在于后者的取值通常只能属于预先确定的可能取值集合之内，例如在{0V, 5V}这一集合中取值。 

模拟电压和电流可直接用来进行控制，如对汽车收音机的音量进行控制。在简单的模拟收音机中，音量旋钮被连接到一个可变电阻。拧动旋钮时，电阻值变大或变小；流经这个电阻的电流也随之增加或减少，从而改变了驱动扬声器的电流值，使音量相应变大或变小。与收音机一样，模拟电路的输出与输入成线性比例。 

尽管模拟控制看起来可能直观而简单，但它并不总是非常经济或可行的。其中一点就是，模拟电路容易随时间漂移，因而难以调节。能够解决这个问题的精密模拟电路可能非常庞大、笨重(如老式的家庭立体声设备)和昂贵。模拟电路还有可能严重发热，其功耗相对于工作元件两端电压与电流的乘积成正比。模拟电路还可能对噪声很敏感，任何扰动或噪声都肯定会改变电流值的大小。 

通过以数字方式控制模拟电路，可以大幅度降低系统的成本和功耗。此外，许多微控制器和DSP已经在芯片上包含了PWM控制器，这使数字控制的实现变得更加容易了。 
　　

### 3.3.3 脉宽调制信号的设计思想

本课题的脉宽调制信号是设定周期为1s矩形波。它的产生将定时计数器设定在10ms定时，后通过寄存器R3来控制脉宽调制信号的周期，本课题只是达到一种模拟的效果，在精确上没有过高的要求，因此将1s周期分成100等份，即设定定时器的定时为10ms，R3中启动定时器的次数100。

寄存器R2中存放的数据是根据检测电路和控制电路转换过来的一个数，R2中存放的数值的大小用于控制脉冲信号，在1s内高电平的时间长短。这样可以从P2.6口检测到定周期脉冲可调的控制信号。

### 3.3.4 脉宽调制信号的作用

脉宽调制信号由P3.0口输出将P3.0口输出的矩形波信号接于双向可控硅的控制端来控制可控硅的通断。当矩形波在一个周期内高电平的时间越长，双向可控硅的导通时间越长，即发热元件上发出的热量也越多。总之，发热元件上释放出能量的高低由矩形波在一个周期内高电平的时间长短所决定的。

### 3.3.5 脉冲宽度调制优点

PWM的一个优点是从处理器到被控系统信号都是数字形式的，无需进行数模转换。让信号保持为数字形式可将噪声影响降到最小。噪声只有在强到足以将逻辑1改变为逻辑0或将逻辑0改变为逻辑1时，也才能对数字信号产生影响。

对噪声抵抗能力的增强是PWM相对于模拟控制的另外一个优点，而且这也是在某些时候将PWM用于通信的主要原因。从模拟信号转向PWM可以极大地延长通信距离。在接收端，通过适当的RC或LC网络可以滤除调制高频方波并将信号还原为模拟形式。

总之，PWM既经济、节约空间、抗噪性能强，是一种值得广大工程师在许多设计应用中使用的有效技术。 

