
# 系统软件调试
对一个单片机系统来说不仅仅只有其性能的好坏、功能强弱以及成本的高低，可靠性也是一个十分重要的指标，如果一个系统的靠靠度不高那么会增加其维修成本降低使用寿命影响其正常的功能。在本系统研发阶段主要能够提高系统可靠性有以下几种方法：
1. 系统自身的可靠性，再设计过程中应减少设计和制作对系统自身可靠性的影响。
2. 抗干扰技术：提高系统的开干扰能力能够降低在实际运行时外部因素对于系统的影响。
3. 系统的容错性设计：要明确系统在受到外部因素影响时，系统能够进行避免和减少损失。
## 系统自身的可靠性设计
系统自身的可靠性是是通过自身硬件设计和软件设计来决定的，在硬件设计时能降低不稳定因素方法就是尽量在电路中少用器件，这样可以降低元器件失效对于系统自身的影响，当时当电路设计进行简化是会造成功能实现，这样的话并不能提高系统自身的稳定性，所以在设计时，为了尽最大程度对系统可靠性的保证，选择了对主芯片进行最大化利用，尽量开发其内丰富资源从简外围电路的设计，降低元件对自身的影响。在软件方面也应避免程序的冗杂。

## 硬件调试

首先应进行上电前的准备。为了防止硬件的损坏，应在电路板上电前进行电路检查，包括：对芯片的焊接方向进行检查，对芯片的引脚进行短路和断路检查。

在经过检查确认芯片的焊接没有任何问题的情况下，进行上电检查，在电源打开后，先判断电路是否存在异常，如出现芯片过热等现象，应及时切断电源，检查电路故障。在上电无异常状况的前提下，可以用万用表和示波器进行测量。首先测量电源芯片的输出电压是否正常，然后用示波器分别测量各个主要芯片电源引脚，察看电源的波形情况，如有纹波，则在预先留出的位置上焊上退耦电容以消除纹波，保证芯片工作正常。电源测量完毕后，进一步用示波器测量有源晶振的输出脚，其输出是频率为8MHz的波形(非方波，类似正弦波)。在确定晶振起振后，按住复位键，使单片机始终保持在复位状态，同时测量其各个引脚的电平情况，并同数据手册上表述的复位时的芯片引脚状态进行比对，由此可判断单片机是否正常。确认单片机正常之后就可以通过仿真器连接用户板进行调试。

## 软件的调试

由于软件的编写都是根据各个模块进行的，我们在进行软件的系统模拟调试时应，先确认硬件的接口标记是否在软件程序中一一对应，而且要检测所编写的软件有没有知识性的错误。在觉得基本没有问题后我们通过电脑将程序编译进入系统核心AT89S52单片机，检验软件与硬件各部分是否协调的工作。出现问题时我们要耐心的检查程序并作出适当的修改，直到软件系统的完全契合硬件电路，那我们软件就调试成功了。

1. 测试环境
   环境温度28摄氏度，室内面积20平方米
   测试仪器：数字万用表，温度计0----100摄氏度

2. 测试方法
   使系统运行，采用温度计同时测量室内度变化情况，得出系统测量的温度。

3. 测试结果
   设定温度由0摄氏度到40摄氏度
   标定温差<=1摄氏度   调节时间  15s（具体视现场情况）
   静态误差<=0.5摄氏度   最大超调量1摄氏度

4. 通过测试分析，对于实际室内的温度控制，可以再提出以下 2 点方法 :
   Ⅰ增加传感器个数，对各个温度传感器采集的数据进行求算术平均，可得到较为准确的温度值。
   Ⅱ对实际室内的温度控制，可采用功率较大的电炉，并且通过风扇对箱内温度进行充分搅和降温设备可采用空气压缩机等制冷设备。 

5. 通过实验测试和分析，发现虽然传感器的温度采集精度最高可得到 0.06 ℃，但测试得到的数据最小间隔为 0.03 ℃ 。通过分析，当对浮点数求平均处理时，遇到同一时刻两个传感头采集的温度相差不大，使 0.06 ℃ 时求出平均温度变为 0.03 ℃ 为了解该数据是否真实，可采用一个高精度的数字温度计测试，发现读出的值与其基本一致，由此推断如果在同一时间增加采集温度的个数，则可以进一步提高温度的精度。 

    

## 注意事项

1. 测驱动电路的过程中发现数码管不能正常显示的情况，经检验发现主要是由于接触不良的问题。其中包括线的接触不良和芯片的接触不良，在实验过程中，数码管有几段时隐时现。用万用表检测发现有线接触不良，重焊后就可正常显示。而芯片接触不良用万用表欧姆档检测有几个引脚本该相通的地方却未通，其解决方法为把芯片拔出正对万能板孔均匀用力插入。
2. 由于焊接时的大意损坏了元件，在调试是我们怎么都找不到问题的所在，我们是用排除法一个一个元件的测试的找出损坏的元件，重新换上新的元件，故障得以解决。
3. 还有关于程序调试过程中出现的问题。执行程序是发现程序执行不稳定，排除软件的错误外，经老师的指导才发现单片机的EA管脚没有接地。因为次程序只用到片内程序存储器，所以在程序执行时一定要把管脚接的，这样程序才能只执行片内的，不然程序会乱跳，从而导致程序执行不稳定。
4. 接三极管的过程中，发现电路不管程序是什么，数码管都是显示8字，经查除发现原来是三极管的极端弄错了，从新调整极端顺序。
5. 在电路调试时由于我们选用的是对射型的光电传感器由于没正对好使的调试一度中断，最后我们通过反复的调试解决了问题
6. 调试时由于线路的繁杂，没有仔细的找到对应部分的线路，使的调试的结果与预期出现很大的误差，我们通过梳理线路后就调试成功了并达到了预期的效果。

## 实验结果

首先按照电路将元器件焊在了电路板上，在硬件实物焊好了以后我首先电气其的电气连接进行了测试，来测量一下是否有缺焊、漏焊的现象，检查完引脚连接后，进行组装，硬件实物如图4-1所示


![图4-1 实物图](http://my.gunplan.top/static/mfd/401.png)




然后显示直接通电，有内部没有程序人，不能实现功能测试，进行这一目的的主要原因是对传感器进行了一下测试，测试其输出湿度是否为方波，温度输出是否为电压信号测量结果如图4-2所示：

![图4-2 测湿波形](http://my.gunplan.top/static/mfd/402.png)


由图可知传感器湿度采集电路输出波形性为稳定的方波与理论计算相符合，传感器没有问题可以进行数据采集。

在硬件测试没有问题后将程序通过烧录器将程序下载到单片机中，程序下载软件采用prognisp软件下载下载方式如图4-3所示：

 图4-3 程序烧录界面

将单片机程序下载后，由于初始设定值为0，所以温湿度会报警，而且显示当前的温湿度值如图4-4所示。

![图4-3 程序下载后界面显示](http://my.gunplan.top/static/mfd/403.png)



按照功能设计通过设置可以将温湿度的最大值和最小值进行设定如图4-4所示：

![图4-4 最大值设置界面](http://my.gunplan.top/static/mfd/404.png)


在设定后可以通过长按设定键将系统转换为自动方式并且设定其自动控制的温湿度的值，具体步骤过如图4-5所示

![图4-5 自动模式](http://my.gunplan.top/static/mfd/405.png)

最后是对其控制功能进行设定由于本设计在输电电压为220v，由于实验室的条件有限只能对其输出电压进行测量其输出电压经测量输出电压为229V。

在这步骤都完成之后，在之后的几天对室内温湿度进行了相应的测量，来进行对其结果如表4-1所示

表4-1 测量数据

| 日期 | 温度（℃） | 湿度（%RH） | 实际温度（℃） | 实际湿度（%RH） |
| ---- | --------- | ----------- | ------------- | --------------- |
| 12   | 24.1      | 50.1        | 26            | 46.             |
| 13   | 25.6      | 47.6        | 27            | 50              |
| 14   | 24.7      | 55.4        | 27            | 53              |
| 15   | 25.5      | 57.2        | 23.8          | 54              |
| 16   | 26.2      | 53.2        | 28            | 55              |

由表可知，温度误差在1.96℃，湿度误差在2.88%RH测量值相对精确。

## 出现问题及解决办法

1. 程序下载后硬件显示的是当前湿度的频率值，并不是实际的湿度值，那么经测量传感器并没出问题，那么在测量硬件接口电压时发现T1电压被拉高，经过检差发现是定时器初始化的问题，重新定义之后发现湿度显示正常，问题解决。

2. 在程序刚下载到单片机中时初始化其温湿度最大和最小值都为零，发生报警信号，报的警灯亮，但是在其设定之后报警声音消除但是报警灯继续亮，经检验发现为程序中灯输出端口的赋值不对经改正后故障消除

## 本章小结

由于实验条件和资源的问题只能对于产品的功能进行测量，其抗干扰能力及精度校准就无法实现但是，在功能测试时，产品实现对于设计目的要求，达到了目标，虽然在误差方面出现了一些浮动，但是考虑到产品元件的精度可能有误差造成测量精度的问题，这种情况下，由于个人的能力无法实现提高，但是其精度相差不大可以满足设计要求，实现温湿度的测量和控制。在调试过程中所遇到的问题不大，大多数为软件设计上的问题。所以在这里也对我所设计有所展望：

1、使用更高精度的电器元件来进行焊接，使其精度更高，

2、可以采用就更加先进的传感器使测量结果更精确。

3、希望能够添加一些隔离模块使仪表的抗干扰能力增强